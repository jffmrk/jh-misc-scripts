#!/usr/bin/env bash

usage() {
  cat >&2 <<EOF
Usage: gh-changelog [OPTIONS] [...REVSPEC]
Generate a changelog based on merged PRs from GitHub

OPTIONS
-b       Branch - The git branch to operate on (default HEAD)
-h       Help - Show this help message
-o       Owner - The GitHub repository owner (defaults to the current repo owner)
-r       Repo - The GitHub repository (defaults to the current repo)
-s       Max Skips - The maximum number of PRs that will be skipped before
           deciding that we're done (default 10).
-v       Verbose - Print verbose messaging
EOF
}

msg() {
  printf '%s\n' "$*" >&2
}

verbose() {
  [ -n "$verbose" ] && msg "$@"
}

error_exit() {
  msg "$@"
  exit 1
}

# usage_error(message...)
# Print an error and usage information, then exit
usage_error() {
  [ "$#" -gt 0 ] && printf '%s\n\n' "$*" >&2
  usage
  exit 1
}

if ! command -v git > /dev/null; then
  error_exit 'git is required'
fi

if ! command -v gh > /dev/null; then
  error_exit 'The GitHub CLI (gh) is required https://cli.github.com/'
fi

if ! command -v jq > /dev/null; then
  error_exit 'The jq JSON parser is required https://stedolan.github.io/jq/'
fi

while getopts :b:ho:r:s:v opt; do
  case "$opt" in
    b) branch="$OPTARG" ;;
    h) usage && exit ;;
    o) owner="$OPTARG" ;;
    r) repo="$OPTARG" ;;
    s) max_skips="$OPTARG" ;;
    v) verbose=1 ;;
    \?) usage_error "Invalid option -${OPTARG}" ;;
    :) usage_error "Missing value for option -${OPTARG}" ;;
  esac
done
shift $((OPTIND - 1))

# [ "$#" -ge 2 ] || usage_error 'At least 2 arguments are required'

if [ -z "$owner" ] || [ -z "$repo" ]; then
  url="$(git remote get-url origin)"
  [ "$?" -ne 0 ] && error_exit 'Could not get git branch'

  if [ -z "$owner" ]; then
    owner="${url%%/*}"
    owner="${owner##*[:/]}"
  fi

  if [ -z "$repo" ]; then
    repo=${url##*/}
    repo="${repo%%.*}"
  fi
fi

if [ -z "$branch" ]; then
  branch="$(git rev-parse --abbrev-ref HEAD)"
  [ "$?" -ne 0 ] && error_exit 'Could not get git head branch name'
fi

if [ "$#" -gt 0 ]; then
  revspec=("$@")
else
  start="$(git describe --tags --abbrev=0 "$branch")"
  [ "$?" -ne 0 ] && error_exit 'Could not get git latest tag'

  end="HEAD"
  revspec=("$start..$end")
fi

[ -z "$max_skips" ] && max_skips=25

verbose "Owner: $owner"
verbose "Repo: $repo"
verbose "Branch: $branch"
verbose "Revspec: ${revspec[*]}"

while read -r line; do
  refs+=("$line")
done < <(git rev-list "${revspec[*]}")

page=1
not_found=0
while true; do
  while read -r line; do
    number="$(echo "$line" | cut -f1)"
    merge_commit_sha="$(echo "$line" | cut -f2)"
    title="$(echo "$line" | cut -f3)"
    user="$(echo "$line" | cut -f4)"

    if [ -z "$merge_commit_sha" ]; then
      verbose "No merge commit for ${number}. Skipping"
      continue
    fi

    if [[ " ${refs[@]} " =~ " ${merge_commit_sha} " ]]; then
      [ -z "$started" ] && verbose "${merge_commit_sha} found. Starting."
      started=1
      echo "- ${title} #${number} ${user}"
    elif [ -n "$started" ]; then
      verbose "${merge_commit_sha} not found"
      not_found=$((not_found + 1))
    fi

  done < <(
    gh api "repos/${owner}/${repo}/pulls?base=${branch}&page=${page}&state=closed" \
      | jq -r 'map([.number,.merge_commit_sha,.title,.user.login]) | .[] | @tsv'
  )

  if [ "$not_found" -ge "$max_skips" ]; then
    verbose "${not_found} PRs not found in revspec (> ${max_skips}). Stopping"
    break
  fi
  page=$(( page + 1 ))
done
